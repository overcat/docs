<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!--

  Want to contribute to this site? Take a look at the GitHub repository for this
  site: https://github.com/stellar/developers

  -->
  <title>Known issues | Stellar Developers</title>
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->
  <meta name="author" content="Stellar.org and contributors">

  <meta property="og:title" content="Known issues | Stellar Developers">
  <meta property="og:type" content="website">


  <link rel="stylesheet" href="/styles/index-cff14d28bafbba60930f31b923b4e75b.css">

  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicon/rocket-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicon/rocket-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/rocket-180x180.png">
  <link rel="icon" type="image/png" href="/images/favicon/rocket-96x96.png" sizes="96x96">
  <meta name="msapplication-TileImage" content="/images/favicon/rocket-144x144.png">

  <script type="text/javascript">
    var $mcGoal = {'settings':{'uuid':'c001d97369b7a10d224c23867','dc':'us9'}};
    (function() {
      var sp = document.createElement('script'); sp.type = 'text/javascript'; sp.async = true; sp.defer = true;
      sp.src = ('https:' == document.location.protocol ? 'https://s3.amazonaws.com/downloads.mailchimp.com' : 'http://downloads.mailchimp.com') + '/js/goal.min.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(sp, s);
    })();
  </script>

  <script>window.clientData = {};</script>

  <script type="text/javascript">
  setTimeout(function(){var a=document.createElement("script");
  var b=document.getElementsByTagName("script")[0];
  a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0065/1320.js?"+Math.floor(new Date().getTime()/3600000);
  a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
  </script>
</head>
<body>
<div class="header2016">
  <div class="header2016__logo header2016__logo--spaced">
    <div class="so-siteHeader">
      <span class="so-logo">
  <a href="https://www.stellar.org/" class="so-logo__main">Stellar</a><!--
  --><span class="so-logo__separator"> </span><!--
  --><a href="/" class="so-logo__subSite">developers</a>
</span>
    </div>
  </div>
  <nav class="header2016__nav mainNavMenu spu-padStart-30">
    <a class="mainNavMenu__item " href="/guides/">&#x6307;&#x5357;</a>
<a class="mainNavMenu__item " href="/reference/">API &#x53C2;&#x8003;&#x624B;&#x518C;</a>
<a class="mainNavMenu__item is-currentItem" href="/software/">&#x8F6F;&#x4EF6;</a>
<a class="mainNavMenu__item " href="/tools/">&#x5DE5;&#x5177;</a>
  </nav>
</div>

<div class="S-flex-row">
  <div class="siteSidebar pageNavListBounder">
  <div class="mainSidebar">
    <ul class="pageNavList">

      <li class="pageNavList__subList">
        <span class="pageNavList__title">Stellar Core</span>
        <ul class="collapsibleListSet__list">
                    <li class="pageNavList__item"><a href="/stellar-core/software/admin.html">Administration</a></li>
  <li class="pageNavList__item"><a href="/stellar-core/software/commands.html">Commands</a></li>
  <li class="pageNavList__item"><a href="/stellar-core/software/security-protocol-release-notes.html">Security and Protocol release notes</a></li>
  <li class="pageNavList__item"><a href="/stellar-core/software/testnet.html">Testnet</a></li>
          <li class="pageNavList__item"><a href="/stellar-core/software/core-data-flow.pdf">Core Data Flow</a></li>

        </ul>
      </li>
    
      <li class="pageNavList__item"><a href="https://github.com/stellar/go/tree/master/services/federation">Federation Server</a></li>
      <li class="pageNavList__item"><a href="https://github.com/stellar/bridge-server">Bridge Server</a></li>
      <li class="pageNavList__item"><a href="https://github.com/stellar/go/tree/master/tools/stellar-archivist">Archivist</a></li>
      <li class="pageNavList__item"><a href="https://github.com/stellar/go/tree/master/services/horizon">Horizon</a></li>
      <li class="pageNavList__item"><a href="/developers/software/known-issues.html">Known Issues</a></li>
    </ul>
  </div>
</div>
  <div class="S-flexItem-share">
  <div class="spu-padSE-30">
    <h1 class="mainSectionTitle">
      Known issues
      
    </h1>
  </div>
  <div class="S-flex-rowWrap spu-borderTop-1 spu-borderColor-neutral7">
    <s-read-md class="S-flexItem-share mainContent s-read-md--capped spu-padSE-30 spu-padTB-20 documentRead" link-process-md="">
      <p>This document describes a list of known issues and potential recovery steps.</p>
<ul>
<li><a href="#gaps-detected">Gaps Detected</a>
<ul>
<li><a href="#symptoms">Symptoms</a></li>
<li><a href="#reasons-for-this-error">Reasons for this error</a>
<ul>
<li><a href="#mismatched-stellar-corehorizon-configurations">Mismatched stellar-core/Horizon configurations</a>
<ul>
<li><a href="#missing-cursors">Missing cursors</a></li>
<li><a href="#mismatch-policy-between-stellar-core-and-horizon">Mismatch policy between stellar-core and Horizon</a></li>
</ul>
</li>
<li><a href="#corrupt-database">Corrupt database</a></li>
</ul>
</li>
<li><a href="#recovery-process">Recovery process</a>
<ul>
<li><a href="#reset-everything">Reset everything</a></li>
<li><a href="#bridging-the-gap">Bridging the gap</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#backfilling-history">Backfilling history</a>
<ul>
<li><a href="#check-your-configuration">Check your configuration</a></li>
<li><a href="#recovery-process-1">Recovery process</a>
<ul>
<li><a href="#reset-everything-1">Reset everything</a></li>
<li><a href="#manually-backfill-history">Manually backfill history</a>
<ul>
<li><a href="#preparation-steps">Preparation steps</a></li>
<li><a href="#reconstruction-steps">Reconstruction steps</a></li>
<li><a href="#merging-steps">Merging steps</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="gaps-detected"><a class="anchorShortcut" href="#gaps-detected" aria-hidden="true"></a> Gaps Detected</h1>
<h2 id="symptoms"><a class="anchorShortcut" href="#symptoms" aria-hidden="true"></a> Symptoms</h2>
<p>Horizon will give an error similar to</p>
<pre><code>Gap detected in stellar-core database. Please recreate Horizon DB.
</code></pre>
<h2 id="reasons-for-this-error"><a class="anchorShortcut" href="#reasons-for-this-error" aria-hidden="true"></a> Reasons for this error</h2>
<h3 id="mismatched-stellar-corehorizon-configurations"><a class="anchorShortcut" href="#mismatched-stellar-corehorizon-configurations" aria-hidden="true"></a> Mismatched stellar-core/Horizon configurations</h3>
<p>Horizon and stellar-core run independently of each other.</p>
<p>stellar-core produces meta data information that is then imported by Horizon.</p>
<p>Gaps occur when for some reason, Horizon doesn&#x2019;t find data for a ledger that it didn&#x2019;t import yet.</p>
<p>This can happen for a few reasons.</p>
<h4 id="missing-cursors"><a class="anchorShortcut" href="#missing-cursors" aria-hidden="true"></a> Missing cursors</h4>
<p>stellar-core uses &#x201C;cursors&#x201D; to ensure that garbage collection doesn&#x2019;t delete data needed by consumers.</p>
<p>If cursors have not been configured, what can happen is that before Horizon has a chance to set a cursor, stellar-core&#x2019;s garbage collection can run and delete some data that Horizon expects.</p>
<p>Solution is to properly define cursors in stellar-core&#x2019;s configuration:</p>
<pre><code class="language-yaml">KNOWN_CURSORS=[&quot;HORIZON&quot;]
</code></pre>
<h4 id="mismatch-policy-between-stellar-core-and-horizon"><a class="anchorShortcut" href="#mismatch-policy-between-stellar-core-and-horizon" aria-hidden="true"></a> Mismatch policy between stellar-core and Horizon</h4>
<p>When running stellar-core with partial history <code>CATCHUP_COMPLETE=false</code>, stellar-core&#x2019;s policy is to keep up with the network with a contiguous tail of at least <code>CATCHUP_RECENT</code> ledgers.</p>
<p>As a consequence, if stellar-core is taken offline for any reason, when it&#x2019;s powered back on, its goal is to catchup to the current ledger <code>N</code> from the network as quickly as possible by replaying ledgers that will include all ledgers from <code>N-CATCHUP_RECENT</code> up to <code>N</code>.</p>
<p>If stellar-core is offline longer than roughly <code>CATCHUP_RECENT</code> * 5 seconds (the average time between ledgers), it&#x2019;s possible that it will not replay certain ledgers.</p>
<p>Horizon on the other hand expects to replay all ledgers passed its initial ledger.</p>
<p>Here is an example to illustrate all this.</p>
<p>Assume Horizon started to ingest at ledger 10,000, it therefore expects stellar-core to emit data for all ledgers past 10,000.
stellar-core is configured with <code>CATCHUP_RECENT=1024</code> (roughly 85 minutes of tail ledgers).</p>
<p>everything is running fine until one day at ledger 500,000 stellar-core is taken down for a day.
At this point we have:</p>
<ul>
<li>stellar-core&#x2019;s latest ledger is 500,000</li>
<li>Horizon ingested ledger 500,000 (or something like 499,999 if it was a bit behind)</li>
</ul>
<p>Later, stellar-core is taken back online.
The network happens to be at ledger 520,000 (that&#x2019;s ~27 hours later), which causes stellar-core to</p>
<ul>
<li>catchup starting at 520,000-1024 = 518,976 (in reality right before that)</li>
<li>replay ledgers up to 520,000 ; at this point it&#x2019;s in &#x201C;Synced!&#x201D; state</li>
<li>close ledgers 520,001 and so on with the network</li>
</ul>
<p>Horizon was at 500,000 but now sees ledger 518,976 &#x2026; where is 500,001?</p>
<p>It panics with</p>
<pre><code>Gap detected in stellar-core database. Please recreate Horizon DB.
</code></pre>
<h3 id="corrupt-database"><a class="anchorShortcut" href="#corrupt-database" aria-hidden="true"></a> Corrupt database</h3>
<p>Some bugs can cause Horizon to get confused during ingestion.</p>
<h2 id="recovery-process"><a class="anchorShortcut" href="#recovery-process" aria-hidden="true"></a> Recovery process</h2>
<h3 id="reset-everything"><a class="anchorShortcut" href="#reset-everything" aria-hidden="true"></a> Reset everything</h3>
<p>In many cases resetting your instance is the simplest way to recover: the data will be reconstructed from history.</p>
<p>It&#x2019;s a good occasion to double check that your configuration in both stellar-core and Horizon are consistent with each other.</p>
<p>Pros:</p>
<ul>
<li>recovery is very likely as you will be importing data from a clean state</li>
<li>data in Horizon is reconstructed with the latest code, providing the most detailed</li>
</ul>
<p>Cons:</p>
<ul>
<li>importing a lot of ledgers can take a long time</li>
<li>stellar-core and Horizon are not available during the recovery process</li>
</ul>
<h3 id="bridging-the-gap"><a class="anchorShortcut" href="#bridging-the-gap" aria-hidden="true"></a> Bridging the gap</h3>
<p>Note: if stellar-core is configured with <code>CATCHUP_COMPLETE=true</code> you can either switch your node to partial history (as it was already ingested by Horizon) or reset everything.</p>
<ol>
<li>find out at what is the latest ledger (let&#x2019;s refer to it as <code>MY_LEDGER_NUMBER</code>) that Horizon ingested
<ul>
<li>you can get this by calling the &#x2018;/metrics&#x2019; endpoint on the Horizon server, the field is history.latest_ledger</li>
<li>for example for the SDF public network this data is at <a href="https://horizon.stellar.org/metrics">https://horizon.stellar.org/metrics</a></li>
</ul>
</li>
<li>stop stellar-core and horizon</li>
<li>look at the value of history.latest_ledger for the public network, SDF <a href="https://horizon.stellar.org/metrics">https://horizon.stellar.org/metrics</a>
<ul>
<li>this value will be somehow larger than <code>MY_LEDGER_NUMBER</code> , substract the two to get the gap between your instance and SDF&#x2019;s</li>
<li>multiply this number by some safety factor (how long do you think you will need to get back in business) to be safe you can use 10 as a ratio.</li>
</ul>
</li>
<li>in your stellar-core config:
<ul>
<li>set CATCHUP_RECENT to that computed value, your configuration will look something like</li>
</ul>
</li>
</ol>
<pre><code class="language-yaml">CATCHUP_COMPLETE=false
CATCHUP_RECENT=50000
</code></pre>
<ul>
<li>set cursors if not set already</li>
</ul>
<pre><code class="language-yaml">KNOWN_CURSORS=[&quot;HORIZON&quot;]
</code></pre>
<ol start="5">
<li>call &#x201C;newdb&#x201D; on the stellar-core instance to reset stellar-core&#x2019;s database</li>
<li>start up stellar-core normally, wait for it to be in &#x201C;Synced!&#x201D; state</li>
<li>start up Horizon, it should be able to see that stellar-core has data to ingest</li>
</ol>
<h1 id="backfilling-history"><a class="anchorShortcut" href="#backfilling-history" aria-hidden="true"></a> Backfilling history</h1>
<p>In this case, you have a stellar-core instance that works properly (it has the ability to close ledgers without error), but you realize
that for some reason its history is incomplete, in the sense that the oldest
ledger available for Horizon to import is not old enough.</p>
<p>Many of the same reasons that can lead to this issue include some of the same problems that lead to
<a href="#gaps-detected">gaps being detected</a>.</p>
<h2 id="check-your-configuration"><a class="anchorShortcut" href="#check-your-configuration" aria-hidden="true"></a> Check your configuration</h2>
<p>Follow the steps in <a href="#mismatched-corehorizon-configurations">mismatched core/Horizon configurations</a></p>
<p>In particular, if the reason you have missing data is because of
garbage collection, you want to make sure that it doesn&#x2019;t happen again in the
future!</p>
<h2 id="recovery-process-2"><a class="anchorShortcut" href="#recovery-process-2" aria-hidden="true"></a> Recovery process</h2>
<p>Important, before attempting any recovery process:</p>
<ul>
<li>Make sure that your configuration is correct (and if not adjust it)</li>
<li><strong>BACKUP</strong> all data on your stellar-core node.</li>
</ul>
<h3 id="reset-everything-2"><a class="anchorShortcut" href="#reset-everything-2" aria-hidden="true"></a> Reset everything</h3>
<p>The easiest way to recover is to <a href="#reset-everything">reset everything</a>.</p>
<p>This will take some time for the running processes, but it doesn&#x2019;t require manual intervention.</p>
<h3 id="manually-backfill-history"><a class="anchorShortcut" href="#manually-backfill-history" aria-hidden="true"></a> Manually backfill history</h3>
<p>The general idea behind this method is to construct the missing data on a
separate stellar-core instance, followed by an &#x201C;import&#x201D; into the instance you are trying to recover.</p>
<p>Note that <strong>Horizon does not support backfilling</strong>: it will have to reingest all
data from stellar-core.</p>
<h4 id="preparation-steps"><a class="anchorShortcut" href="#preparation-steps" aria-hidden="true"></a> Preparation steps</h4>
<ol>
<li>Stop Horizon.</li>
<li>Set the <code>HORIZON</code> cursor to 0 (which will stop garbage collection from continuing)</li>
</ol>
<pre><code>stellar-core --conf X.conf &apos;setcursor?id=HORIZON&amp;cursor=0&apos;
</code></pre>
<ol start="3">
<li>Stop your stellar-core instance.</li>
<li>Connect to your stellar-core database, and run:</li>
</ol>
<pre><code class="language-sql">SELECT ledgerseq FROM ledgerheaders ORDER BY ledgerseq ASC LIMIT 1;
</code></pre>
<p>This will return the <em>smallest</em> ledger that your stellar-core instance currently knows about.</p>
<p>We&#x2019;ll call this value <code>ORIGINAL_LOW_LEDGER</code> for now on.</p>
<p>We&#x2019;ll call <code>LOW_LEDGER</code> the value that you want in history.</p>
<h4 id="reconstruction-steps"><a class="anchorShortcut" href="#reconstruction-steps" aria-hidden="true"></a> Reconstruction steps</h4>
<p>Steps here are going to reconstruct history for the range <code>LOW_LEDGER .. ORIGINAL_LOW_LEDGER</code></p>
<ol>
<li>Prepare a fresh new stellar-core instance with a similar configuration file.
<ul>
<li>Use a different database, sqlite even</li>
<li>don&#x2019;t start it after running <code>newdb</code></li>
</ul>
</li>
<li>Perform a command line catchup to replay a range of ledger that includes the target range:</li>
</ol>
<pre><code>stellar-core --conf X.conf --catchup-at LOW_LEDGER --catchup-to ORIGINAL_LOW_LEDGER
</code></pre>
<p>If this succeeds you can proceed to next step - merging.</p>
<h4 id="merging-steps"><a class="anchorShortcut" href="#merging-steps" aria-hidden="true"></a> Merging steps</h4>
<p>Repeat the following steps for the following sql tables:</p>
<ul>
<li><code>ledgerheaders</code> (<code>ledgerseq</code>)</li>
<li><code>txhistory</code> (<code>ledgerseq</code>)</li>
<li><code>txfeehistory</code> (<code>ledgerseq</code>)
Not imported from history as of this writing:</li>
<li><code>scphistory</code></li>
<li><code>scpquorums</code></li>
</ul>
<p>We&#x2019;ll use <code>ledgerheaders</code> here to illustrate.</p>
<ol>
<li>On the temporary node, export the data from <code>ledgerheaders</code> (save into a file <code>ledgerHeaders.sql</code>)</li>
</ol>
<pre><code class="language-sql">SELECT * from ledgerheaders WHERE ledgerseq &gt;= LOW_LEDGER AND ledgerseq &lt; ORIGINAL_LOW_LEDGER
</code></pre>
<ol start="2">
<li>(Optional) Verify that the hash of ledger <code>ORIGINAL_LOW_LEDGER - 1</code> is the one stored in ledger <code>ORIGINAL_LOW_LEDGER</code>.</li>
</ol>
<pre><code class="language-sql">SELECT ledgerhash FROM ledgerheaders WHERE ledgerseq = ORIGINAL_LOW_LEDGER-1
</code></pre>
<ol start="3">
<li>Login into the stellar-core database and run the following:</li>
</ol>
<pre><code class="language-sql">SELECT prevhash FROM ledgerheaders WHERE ledgerseq = ORIGINAL_LOW_LEDGER
</code></pre>
<p>Verify that this value is the same than the <code>ledgerhash</code> returned on the previous step.</p>
<ol start="4">
<li>Import the data exported in step 1.</li>
<li>Verify that there aren&#x2019;t any gaps within the history.</li>
</ol>
<pre><code class="language-sql">SELECT lh1.ledgerseq FROM ledgerheaders AS lh1 WHERE lh1.ledgerseq NOT IN ( SELECT lh2.ledgerseq-1 FROM ledgerheaders AS lh2 WHERE lh2.ledgerseq = lh1.ledgerseq + 1);
</code></pre>
<p>When this is completed, you can start stellar-core and wait for it to catch up to the network.</p>
<p>Finally, you can reset Horizon and have it ingest all data from <code>stellar-core</code>.</p>

      <br>
      <a href="https://github.com/overcat/stellar-docs/blob/master/software/known-issues.md" class="spu-color-neutral6">Edit this doc in GitHub</a>
    </s-read-md>
  
  </div>
</div>
</div>

<div class="so-back spu-borderTop-1 spu-borderColor-neutral7 spu-padTB-15">
  <div class="so-chunk">
    <div class="siteFooter">
      <div class="siteFooter__list">
        <a class="siteFooter__list__item" href="https://www.stellar.org/"><span class="graphic-backArrow-9"></span>&#xA0;&#xA0;Stellar.org</a>
        <span class="siteFooter__list__sep">|</span>
        <a class="siteFooter__list__item" href="https://www.stellar.org/bug-bounty-program/">Bug &#x60AC;&#x8D4F;</a>
        <a class="siteFooter__list__item" href="/stellar-core/software/admin.html">&#x8FD0;&#x884C;&#x8282;&#x70B9;</a>
        <a class="siteFooter__list__item" href="/guides/things-to-build.html">&#x6784;&#x5EFA;&#x5E94;&#x7528;</a>
        <a class="siteFooter__list__item" href="https://github.com/stellar/">GitHub</a>
        <a class="siteFooter__list__item" href="http://slack.stellar.org/">&#x6765;&#x793E;&#x533A;&#x7545;&#x8C08;</a>
      </div>
      <div class="siteFooter__list siteFooter__list--aux">
        <a class="siteFooter__list__item siteFooter__list__item--aux" href="https://www.stellar.org/terms-of-service/">&#x670D;&#x52A1;&#x6761;&#x6B3E;</a>
        <a class="siteFooter__list__item siteFooter__list__item--aux" href="https://www.stellar.org/privacy-policy/">&#x9690;&#x79C1;&#x653F;&#x7B56;</a>
      </div>
    </div>
  </div>
</div>
</body>
<script src="/js/app-9b8f1b0df3650f3a8dabc0e0b08ccab9.js"></script>
<script type="text/javascript">
!function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
analytics.load("U8cLXTFMPm");
analytics.page()
}}();
</script>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5V3WNNP');</script>
<!-- End Google Tag Manager -->

<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5V3WNNP" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
</html>
